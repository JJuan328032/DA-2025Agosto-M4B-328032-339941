<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración</title>
    <link rel="stylesheet" href="css/menu_administrador.css">
    <script src="vistaWeb.js"></script>
    <script src='sse.js'></script>
</head>
<body>
    <script src="utilesVista.js"></script>
    <!-- Sidebar -->
    <nav class="sidebar" id="sidebar-menu">
        <button class="toggle-button" onclick="toggleSidebar()"></button>
        <div class="nav-container">
            <h2><span style="text-decoration: none; color: inherit;" id="nombre"></span></h2>
            <ul class="nav-links">
                <li><button onclick="cargarContenido('asignar_bonificaciones.html')" class="nav-button">Asignar Bonificación</button></li>
                <li><button onclick="cargarContenido('emular_transito.html')" class="nav-button">Emular Tránsito</button></li>
                <li><button onclick="cargarContenido('cambiar_estado.html')" class="nav-button">Cambiar Estado</button></li>
            </ul>
        </div>
        <button onclick="cerrarSesion()" class="btn-salir">Salir</button>
    </nav>

    <div class="content">
        <iframe id="contenidoFrame" src="presentacion.html"></iframe>
    </div>

    <script>
        // URL para cerrar sesión (a completar)
        urlIniciarVista="/menu/vistaConectada";
        urlCierreVista = "acceso/salirAdministrador";
        urlRegistroSSE="/menu/registrarSSE";
        urlLogin = "login_Administrador.html"
        
        function mostrar_nombre(nombre){
            console.log(nombre);
            document.getElementById("nombre").innerHTML = nombre;
        }

        function cerrarSesion() {
            // Realizar la petición de cierre de sesión
            submit(urlCierreVista, "");
        }

        // Manejador de respuesta exitosa del cierre de sesión
        function mostrar_LogoutExitoso(urlDestino) {
            window.location.href = urlDestino;
        }

        function cargarContenido(pagina) {
            document.getElementById('contenidoFrame').src = pagina;
        }

        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            sidebar.classList.toggle('collapsed');
            
            // Guardar el estado en localStorage para mantenerlo entre recargas
            localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
        }

        function procesarErrorSubmit(status,text){
            if(status==400){
                window.location.href="login_Administrador.html";
            }
        }

        //Cuando llega un mensaje SSE lo delego al iFrame actual como una respuesta del controlador
        function procesarMensajeSSE(mensaje) {
  
            var iframe = document.getElementById('contenidoFrame');
            var iframeWindow = iframe.contentWindow;
            iframeWindow.procesarResultadosSubmit(mensaje); //asumo que el iFrame tiene vistaWeb.js incluida
        }

        // Restaurar el estado del sidebar al cargar la página
        window.addEventListener('load', function() {
            const sidebar = document.querySelector('.sidebar');
            const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
            if (isCollapsed) {
                sidebar.classList.add('collapsed');
            }
        });

        function conexionSSECerrada(event){
              cerrar();
        }

        opcion1 = "Volver a Login";
        opcion2= "Cerrar";

        async function cerrar(){
            ocultarSidebar(true);
            let respuesta = await mostrarConfirmacion("Se ha cerrado la aplicacion en esta ventana", opcion1, opcion2);
            moverPagina(respuesta);
        }

        async function mostrar_accesoDenegado(mensaje){
            ocultarSidebar(true);
            let respuesta = await mostrarConfirmacion(mensaje, opcion1, opcion2);
            moverPagina(respuesta);
        }

        function moverPagina(respuesta){
            if (respuesta) {
                window.location.href = urlLogin;
            }else{
                window.location.href = "index.html";
            }
        }

        function ocultarFondo(mostrarMensaje) {
            const elementos = document.querySelectorAll("nav.sidebar, .content");
            elementos.forEach(el => {
                el.style.visibility = mostrarMensaje ? "hidden" : "visible";
            });
        }
        function ocultarSidebar(ocultar) {
            const sidebar = document.getElementById("sidebar-menu");
            if (!sidebar) return;

            sidebar.style.display = ocultar ? "none" : "block";
        }




    </script>


    <div id="overlay-bloqueo" aria-hidden="true"></div>

</body>
</html>