<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emular Tránsito</title>
    <link rel="stylesheet" href="css/common.css">
    <script src="vistaWeb.js"></script>
</head>
<body>
    <script src="utilesVista.js"></script>
    <div class="page-wrapper">
        <div class="panel">
            <h1>Emular Tránsito</h1>
            <div class="subtitle">Seleccione un puesto, verifique sus tarifas, ingrese una matrícula y emule un tránsito.</div>

            <form id="formEmular" onsubmit="handleEmularTransito(event)" class="emular-grid">
                <div class="left-col">
                    <div class="field">
                        <div class="field-label">Puesto</div>
                        <span id="puestoContainer" onchange="pedirTarifas()" required>Cargando puestos...</span>
                    </div>

                    <div class="field">
                        <div class="field-label">Matrícula</div>
                        <input type="text" id="matricula" name="matricula" placeholder="ABC123" required />
                    </div>

                    <div class="field">
                        <div class="field-label">Fecha y Hora del tránsito</div>
                        <input type="datetime-local" id="fechaHora" name="fechaHora" required />
                    </div>

                    <div>
                        <button type="submit" class="btn-emular">Emular Tránsito</button>
                    </div>
                </div>

                <div class="right-col">
                    <div>
                        <h3 style="margin:0;font-weight:700">Tarifas del Puesto</h3>
                        <div id="tarifas-container" style="margin-top:8px">Seleccione un puesto para ver tarifas</div>
                        <div class="tarifas-note">se muestran categoría y monto actuales del puesto seleccionado</div>
                    </div>
                </div>
            </form>
            <div id="error"></div>
            <div id="resultado-transito" class="result-area">Aquí se mostrarán los datos del tránsito emulado.</div>
        </div>
    </div>

    <script>
        urlIniciarVista = "/emular/inicio";
        urlTarifas = "/emular/tarifas";
        urlEmular = "/emular/transito";
        urlLogin = "login_Administrador.html"


        function mostrar_puestos(puestos){
            document.getElementById("puestoContainer").innerHTML = crearListaDesdeJson({data:puestos,id:"indicePuesto",campoMostrar: "nombre", value: "nombre"});
        }

        function mostrarSelect(){
            const select = document.getElementById("indicePuesto");
            const valorSeleccionado = select.value;
            const textoSeleccionado = select.options[select.selectedIndex].text;

            if (valorSeleccionado === "-1") return;

        }

        function pedirTarifas(){
            const select = document.getElementById("indicePuesto");
            if (!select) {
                console.error("No se encontró el select de puestos");
                return;
            }

            //SI NO HAY TARIFAS, DESAHABILITAR EL BOTON?

            const valorSeleccionado = select.value;
            if (valorSeleccionado === "-1") return;

            const nombre = select.options[select.selectedIndex].text;
            // Construir los datos en formato application/x-www-form-urlencoded
            const params = "nombre=" + encodeURIComponent(nombre);
            
            
            //console.log("Enviando a " + urlTarifas + " con parámetros: " + params);
            submit(urlTarifas, params);
        }


        function mostrar_tarifas(tarifas){
            document.getElementById("tarifas-container").innerHTML = crearTablaDesdeJson(tarifas);
        }


        function handleEmularTransito(event) {
            event.preventDefault(); // SIEMPRE evitamos que refresque

            const select = document.getElementById("indicePuesto");

            if (!select) {
                mostrar_error("No se encontró el selector de puestos.");
                return;
            }

            const valorSeleccionado = select.value;

            if (valorSeleccionado === "-1") {
                mostrar_error("Debe seleccionar un puesto antes de emular el tránsito.");
                return;
            }

            ocultarError(); // limpiar error previo si todo está ok

            submit(urlEmular, serializarFormulario("formEmular"));
        }


        function mostrar_transitoEmulado(datos){
            ocultarError();
            
            // Crear tabla vertical con los datos
            let html = `
                <h3 style="margin-top:20px;margin-bottom:10px;font-weight:700">Resultado del Tránsito</h3>
                <table style="width:100%;border-collapse:collapse;margin-top:10px">
                    <tr><th style="text-align:left;padding:8px;background:#f5f5f5;font-weight:700;border:1px solid #ddd">Propietario</th><td style="padding:8px;border:1px solid #ddd">${datos.propietario}</td></tr>
                    <tr><th style="text-align:left;padding:8px;background:#f5f5f5;font-weight:700;border:1px solid #ddd">Categoría</th><td style="padding:8px;border:1px solid #ddd">${datos.categoria}</td></tr>
                    <tr><th style="text-align:left;padding:8px;background:#f5f5f5;font-weight:700;border:1px solid #ddd">Bonificación</th><td style="padding:8px;border:1px solid #ddd">${datos.bonificacion}</td></tr>
                    <tr><th style="text-align:left;padding:8px;background:#f5f5f5;font-weight:700;border:1px solid #ddd">Costo Tránsito</th><td style="padding:8px;border:1px solid #ddd">${datos.costoTransito}</td></tr>
                    <tr><th style="text-align:left;padding:8px;background:#f5f5f5;font-weight:700;border:1px solid #ddd">Saldo Luego Tránsito</th><td style="padding:8px;border:1px solid #ddd">${datos.saldoLuegoTransito}</td></tr>
                </table>
            `;
            
            document.getElementById("resultado-transito").innerHTML = html;
        }

        function mostrar_error(error){
            aparecerError();
            const div = document.getElementById("error");

            // Cambiar el texto y color
            div.textContent = error || "Ocurrió un error al procesar la solicitud.";
            div.style.background = "#f8d7da";  // rojo claro
            div.style.borderColor = "#dc3545"; // rojo intenso
            div.style.color = "#721c24";       // texto rojo oscuro
        }
        
        async function excepcionDeAplicacion(mensaje){
            await mostrarMensaje(mensaje);
        }

        function aparecerError() {
            document.getElementById("error").style.display = "block";
        }

        function ocultarError() {
            document.getElementById("error").style.display = "none";
        }

        async function excepcionDeAplicacion(text){
            await mostrarMensaje(text);
        }

        async function mostrar_accesoDenegado(mensaje) {
            let respuesta = await mostrarConfirmacion(mensaje, "Volver a Login", "Cerrar");

            // Detectar si el script está corriendo dentro de un iframe
            const enIframe = (window.top !== window.self);

            if (respuesta) {
                // Si el usuario elige volver al login
                if (enIframe) {
                    // Redirigir toda la página (no solo el iframe)
                    window.top.location.href = urlLogin;
                } else {
                    window.location.href = urlLogin;
                }
            } else {
                // Si elige ir al index
                if (enIframe) {
                    window.top.location.href = "index.html";
                } else {
                    window.location.href = "index.html";
                }
            }
        }


    </script>

</body>
</html>