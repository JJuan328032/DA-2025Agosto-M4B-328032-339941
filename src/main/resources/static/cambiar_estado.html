<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cambiar Estado</title>
    <link rel="stylesheet" href="css/common.css">
    <script src="vistaWeb.js"></script>
    <script src="utilesVista.js" defer></script>
</head>
<body>
    <div class="page-wrapper">
        <div class="panel">
            <h1>Cambiar Estado de Propietario</h1>
            <div class="subtitle">Ingrese una cédula, revise el estado actual y seleccione un nuevo estado (datos de ejemplo).</div>

            <!-- Panel superior dividido en dos -->
            <div class="emular-grid">
                <!-- Panel Izquierdo: Búsqueda -->
                <div class="left-col">
                    <div class="field">
                        <div class="field-label">Cédula de Identidad</div>
                        <input type="text" id="cedula" name="cedula" placeholder="Ingrese cédula" required>
                        <button class="btn-emular" onclick="buscarPropietario()" style="margin-top:8px;width:100%">Buscar</button>
                    </div>
                </div>

                <!-- Panel Derecho: Estados -->
                <div class="right-col">
                    <div class="field">
                        <div class="field-label">Estados Definidos</div>
                        <div id="estados-container" style="margin-bottom:8px">
                            Busque un propietario para continuar
                        </div>
                        <button class="btn-emular" id="btnCambiarEstado" onclick="cambiarEstado()" disabled style="width:100%">Cambiar Estado</button>
                        <div class="help-text">El estado actual se mostrará preseleccionado</div>
                    </div>
                </div>
            </div>

            <!-- Panel inferior: Información del propietario con borde punteado -->
            <div style="margin-top:24px;padding:15px;border:2px dashed #ddd;background:#f5f5f5;border-radius:8px;display:none" id="panel-propietario">
                <h3 style="margin:0 0 16px 0;font-weight:700">Propietario</h3>
                
                <!-- Grid de dos columnas para Nombre y Estado -->
                <div class="emular-grid" style="gap:16px">
                    <div>
                        <div style="display:block;color:#888;font-size:12px;font-weight:600;margin-bottom:6px">Nombre</div>
                        <div style="background:#fff;padding:12px;border:1px solid #d0d4da;border-radius:6px;min-height:40px;display:flex;align-items:center" id="nombre-propietario">
                            -
                        </div>
                    </div>
                    <div>
                        <div style="display:block;color:#888;font-size:12px;font-weight:600;margin-bottom:6px">Estado</div>
                        <div style="background:#fff;padding:12px;border:1px solid #d0d4da;border-radius:6px;min-height:40px;display:flex;align-items:center" id="estado-propietario">
                            -
                        </div>
                    </div>
                </div>
            </div>

            <!-- Espacio para mensajes -->
            <div id="mensaje-estado" style="margin-top:24px;padding:12px;border:1px solid var(--color-primary);background:#f9f9f9;border-radius:6px;text-align:center;color:#666;transition:all 0.3s ease">
                Seleccione una cédula y realice una búsqueda
            </div>
        </div>
    </div>

    <script>
        // Variables estándar para vistaWeb.js
        var urlIniciarVista = '/estado/opciones';

        var parametrosInicioVista = '';
        var prefijoNombreFuncionProcesoResultado = 'mostrar_';
        var urlLogin = "login_Administrador.html";

        // Cargar estados definidos desde backend
        function mostrar_estadosDefinidos(estados) {
            const container = document.getElementById("estados-container");
            if (!container) {
                console.error("Elemento #estados-container no encontrado en el DOM");
                return;
            }

            container.innerHTML = crearListaDesdeJson({
                data: estados,
                id: "nuevoEstadoNombre",
                campoMostrar: "nombre"
            });

        }

        // Buscar propietario por cédula
        function buscarPropietario() {
            const cedula = document.getElementById('cedula').value.trim();
            if (!cedula) {
                mostrar_mal('Ingrese una cédula');
                return;
            }
            submit('/estado/buscar', 'cedula=' + encodeURIComponent(cedula));
        }

        // Mostrar propietario encontrado
        function mostrar_propietarioEstado(propietarioDTO) {
            if (!propietarioDTO) {
                mostrar_mal("No se encontró propietario con esa cédula.");
                return;
            }

            document.getElementById("panel-propietario").style.display = "block";
            document.getElementById("nombre-propietario").textContent = propietarioDTO.nombreCompleto || "Sin nombre";
            document.getElementById("estado-propietario").textContent = propietarioDTO.estado || "Sin estado";

            // Habilitar botón y preseleccionar estado actual
            const btnCambiar = document.getElementById("btnCambiarEstado");
            btnCambiar.disabled = false;
            
            const selectEstado = document.getElementById("nuevoEstadoNombre");
            if (selectEstado) {
                // Buscar y seleccionar el estado actual
                for (let i = 0; i < selectEstado.options.length; i++) {
                    if (selectEstado.options[i].text === propietarioDTO.estado) {
                        selectEstado.selectedIndex = i;
                        break;
                    }
                }
            }

            mostrar_ok("Propietario encontrado.");
        }

        // Cambiar estado del propietario
        function cambiarEstado() {
            const selectEstado = document.getElementById('nuevoEstadoNombre');
            const nuevoEstadoNombre = selectEstado.options[selectEstado.selectedIndex].text;

            if (!nuevoEstadoNombre || selectEstado.value == -1) {
                mostrar_mal("Debe completar todos los campos.");
                return;
            }

            const data = '&nuevoEstadoNombre=' + encodeURIComponent(nuevoEstadoNombre);

            submit('/estado/cambiar', data);
        }

        // Mensajes visuales
        function mostrar_ok(mensaje) {
            const div = document.getElementById("mensaje-estado");
            div.textContent = mensaje || "Operación realizada con éxito.";
            div.style.background = "#d4edda";
            div.style.borderColor = "#28a745";
            div.style.color = "#155724";
        }

        function mostrar_mal(mensaje) {
            const div = document.getElementById("mensaje-estado");
            div.textContent = mensaje || "Ocurrió un error al procesar la solicitud.";
            div.style.background = "#f8d7da";
            div.style.borderColor = "#dc3545";
            div.style.color = "#721c24";
        }

        function mostrar_error(mensaje) {
            mostrar_mal(mensaje);
        }

        async function mostrar_accesoDenegado(mensaje) {
            let respuesta = await mostrarConfirmacion(mensaje, "Volver a Login", "Cerrar");

            // Detectar si el script está corriendo dentro de un iframe
            const enIframe = (window.top !== window.self);

            if (respuesta) {
                // Si el usuario elige volver al login
                if (enIframe) {
                    window.top.location.href = urlLogin;
                } else {
                    window.location.href = urlLogin;
                }
            } else {
                // Si elige ir al index
                if (enIframe) {
                    window.top.location.href = "index.html";
                } else {
                    window.location.href = "index.html";
                }
            }
        }

        async function excepcionDeAplicacion(mensaje) {
            await mostrarMensaje(mensaje);
        }
    </script>
</body>
</html>
